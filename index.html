<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠ</title>
    <style>
        :root {
            --primary-bg: #111b21;
            --secondary-bg: #202c33;
            --accent-green: #00a884;
            --text-color: #e0e0e0;
            --sent-bubble: #005c4b;
            --received-bubble: #202c33;
            --page-background: #0b141a;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--primary-bg);
            color: var(--text-color);
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .page {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            background: var(--primary-bg);
            position: absolute;
            top: 0;
            left: 0;
        }

        .page.active {
            display: flex;
        }

        header {
            background: var(--secondary-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow-y: auto;
        }

        button {
            padding: 12px 25px;
            background: var(--accent-green);
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }

        input[type="text"], input[type="tel"], input[type="search"] {
            width: 85%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid var(--secondary-bg);
            background: var(--secondary-bg);
            color: white;
            text-align: center;
            font-size: 16px;
        }

        .back-button {
            color: white;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 15px 0 5px;
            margin: 0;
        }

        /* Profile Picture styles */
        .profile-pic-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .profile-pic-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--secondary-bg);
            background: #333;
        }

        .profile-pic-overlay {
            position: absolute;
            bottom: 5px;
            left: 5px; /* Adjusted for RTL */
            width: 40px;
            height: 40px;
            background: var(--accent-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }

        /* Chat List Page */
        #chat-list-page-header {
            justify-content: space-between;
        }

        #my-profile-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background: #333;
        }

        #chat-list-page .content {
            padding: 0;
            width: 100%;
        }
        
        #search-container {
            padding: 8px;
            background: var(--primary-bg);
            width: 100%;
            box-sizing: border-box;
        }

        #search-input {
             width: 100%;
             box-sizing: border-box;
             padding: 10px 15px;
             background: var(--secondary-bg);
             border: none;
             color: white;
             border-radius: 8px;
        }

        #contacts-container {
            flex-grow: 1;
            overflow-y: auto;
            width: 100%;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #1a242a;
            cursor: pointer;
            text-align: right;
            width: 100%;
            box-sizing: border-box;
        }
         .contact-item:hover {
            background: #2a3942;
        }

        .contact-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 15px;
            background: #333;
        }

        /* Chat Page */
        #chat-page {
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
        }

        #chat-page-header {
            justify-content: flex-start;
        }
        #chat-partner-avatar {
             width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #333;
            margin-left: 10px;
        }

        #messages-area {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            color: white;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .message img, .message video {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 5px;
        }
        
        .message audio {
            width: 250px;
            filter: invert(1) sepia(1) saturate(0) hue-rotate(180deg);
        }

        .sent {
            background: var(--sent-bubble);
            align-self: flex-end;
        }

        .received {
            background: var(--received-bubble);
            align-self: flex-start;
        }

        #message-form {
            display: flex;
            padding: 8px;
            align-items: center;
            background: var(--primary-bg);
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 20px;
            border: none;
            background: var(--secondary-bg);
            color: white;
            margin: 0 8px;
        }

        .action-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--accent-green);
            color: white;
            font-size: 24px;
            cursor: pointer;
            border: none;
            padding: 0;
        }
        
        #attachment-button {
            background: none;
            color: #8696a0;
            font-size: 26px;
            transform: rotate(45deg);
        }

        #record-button, #send-button {
            display: none; /* Controlled by JS */
        }
        .recording {
            background: red !important;
        }

    </style>
</head>
<body>

<div id="welcome-page" class="page active">
    <div class="content">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨</h2>
        <p style="color: #a0a0a0;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©" Ù„Ù‚Ø¨ÙˆÙ„ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©.</p>
        <button id="agree-button">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>
</div>

<div id="phone-page" class="page">
    <header>
        <button class="back-button" data-target="welcome-page">â†’ </button>
        <h1>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</h1>
    </header>
    <div class="content">
        <p style="color: #a0a0a0;">Ø³ÙŠÙ‚ÙˆÙ… ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ.</p>
        <input type="tel" id="phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button id="phone-next-button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
</div>

<div id="profile-page" class="page">
    <header><h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1></header>
    <div class="content">
         <p style="color: #a0a0a0;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©.</p>
        <div class="profile-pic-container">
            <label for="register-pic-input">
                <img id="register-pic-preview" class="profile-pic-preview" src="https://via.placeholder.com/150/333333/FFFFFF?text=User">
                <div class="profile-pic-overlay">ğŸ“·</div>
            </label>
            <input type="file" id="register-pic-input" accept="image/*" style="display:none;">
        </div>
        <input type="text" id="register-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        <button id="register-finish-button">Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>
</div>

<div id="chat-list-page" class="page">
    <header id="chat-list-page-header">
        <img id="my-profile-button" src="https://via.placeholder.com/150/333333/FFFFFF?text=Me">
        <h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h2>
    </header>
    <div class="content">
        <div id="search-container">
            <input type="search" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
        </div>
        <div id="contacts-container"></div>
    </div>
</div>

<div id="profile-settings-page" class="page">
    <header>
        <button class="back-button" data-target="chat-list-page">â†’ </button>
        <h1>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    </header>
    <div class="content">
        <div class="profile-pic-container">
            <label for="edit-pic-input">
                <img id="edit-pic-preview" class="profile-pic-preview">
                <div class="profile-pic-overlay">ğŸ“·</div>
            </label>
            <input type="file" id="edit-pic-input" accept="image/*" style="display:none;">
        </div>
        <input type="text" id="edit-name-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input type="tel" id="edit-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" readonly style="background:#111b21; text-align:center;">
        <button id="save-profile-button">Ø­ÙØ¸</button>
    </div>
</div>

<div id="chat-page" class="page">
    <header id="chat-page-header">
        <button class="back-button" data-target="chat-list-page">â†’ </button>
        <img id="chat-partner-avatar">
        <h3 id="chat-partner-name" style="margin-right: 15px;"></h3>
    </header>
    <div id="messages-area"></div>
    <form id="message-form" onsubmit="return false;">
        <button type="button" id="attachment-button" class="action-button">ğŸ“</button>
        <input type="file" id="attachment-input" accept="image/*,video/*" style="display:none;">

        <input type="text" id="message-input" placeholder="Ø±Ø³Ø§Ù„Ø©">
        
        <button type="button" id="record-button" class="action-button">ğŸ¤</button>
        <button type="submit" id="send-button" class="action-button">â¤</button>
    </form>
</div>


<script type="module">
    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off, query, orderByChild, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§
    const firebaseConfig = {
        apiKey: "AIzaSyCcqpstSz3Wg6zQb_-bC0JyjcJjX5c3TQ8",
        authDomain: "saifsa-d4bee.firebaseapp.com",
        databaseURL: "https://saifsa-d4bee-default-rtdb.firebaseio.com",
        projectId: "saifsa-d4bee",
        storageBucket: "saifsa-d4bee.firebasestorage.app",
        messagingSenderId: "56650923251",
        appId: "1:56650923251:web:83ed4afadf44f8eabf0b86"
    };

    try {
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let activeChatPartner = null;
        let registrationData = {
            avatar: "https://via.placeholder.com/150/333333/FFFFFF?text=User"
        };
        let currentMessagesRef = null;
        let currentMessagesListener = null;

        // Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const ui = {
            pages: document.querySelectorAll('.page'),
            backButtons: document.querySelectorAll('.back-button'),
            agreeButton: document.getElementById('agree-button'),
            phoneNextButton: document.getElementById('phone-next-button'),
            phoneInput: document.getElementById('phone-input'),
            registerPicInput: document.getElementById('register-pic-input'),
            registerPicPreview: document.getElementById('register-pic-preview'),
            registerNameInput: document.getElementById('register-name-input'),
            registerFinishButton: document.getElementById('register-finish-button'),
            myProfileButton: document.getElementById('my-profile-button'),
            searchInput: document.getElementById('search-input'),
            contactsContainer: document.getElementById('contacts-container'),
            editPicPreview: document.getElementById('edit-pic-preview'),
            editPicInput: document.getElementById('edit-pic-input'),
            editNameInput: document.getElementById('edit-name-input'),
            editPhoneInput: document.getElementById('edit-phone-input'),
            saveProfileButton: document.getElementById('save-profile-button'),
            chatPartnerName: document.getElementById('chat-partner-name'),
            chatPartnerAvatar: document.getElementById('chat-partner-avatar'),
            messagesArea: document.getElementById('messages-area'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            recordButton: document.getElementById('record-button'),
            attachmentButton: document.getElementById('attachment-button'),
            attachmentInput: document.getElementById('attachment-input'),
        };
        
        // --- Ø¯ÙˆØ§Ù„ Ø£Ø³Ø§Ø³ÙŠØ© ---

        const navigateTo = (pageId) => {
            ui.pages.forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        };

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ---

        const startApp = async () => {
            const savedUserId = localStorage.getItem('whatsapp_currentUser_id');
            if (savedUserId) {
                try {
                    const snapshot = await get(ref(database, 'users/' + savedUserId));
                    if (snapshot.exists()) {
                        currentUser = snapshot.val();
                        initializeAppUI();
                        navigateTo('chat-list-page');
                    } else {
                        localStorage.removeItem('whatsapp_currentUser_id');
                        navigateTo('welcome-page');
                    }
                } catch (error) {
                    console.error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                    alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                    navigateTo('welcome-page');
                }
            } else {
                navigateTo('welcome-page');
            }
        };
        
        ui.agreeButton.onclick = () => navigateTo('phone-page');

        ui.phoneNextButton.onclick = async () => {
            const phone = ui.phoneInput.value.trim();
            if (phone.length < 9) { // Simple validation
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­');
                return;
            }
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹
             const usersRef = ref(database, 'users');
             const snapshot = await get(usersRef);
             let userExists = false;
             let existingUser = null;
             if(snapshot.exists()){
                 snapshot.forEach(child => {
                     const user = child.val();
                     if(user.phone === phone) {
                         userExists = true;
                         existingUser = user;
                     }
                 });
             }
             if(userExists){
                 alert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ.");
                 currentUser = existingUser;
                 localStorage.setItem('whatsapp_currentUser_id', currentUser.id);
                 initializeAppUI();
                 navigateTo('chat-list-page');
             } else {
                 registrationData.phone = phone;
                 navigateTo('profile-page');
             }
        };

        ui.registerPicInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                ui.registerPicPreview.src = await fileToBase64(file);
                registrationData.avatar = ui.registerPicPreview.src;
            }
        };

        ui.registerFinishButton.onclick = async () => {
            const name = ui.registerNameInput.value.trim();
            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }
            registrationData.name = name;
            const userId = `user_${Date.now()}`;
            const newUser = { id: userId, ...registrationData };
            
            try {
                await set(ref(database, 'users/' + userId), newUser);
                currentUser = newUser;
                localStorage.setItem('whatsapp_currentUser_id', currentUser.id);
                alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­!`);
                initializeAppUI();
                navigateTo('chat-list-page');
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }
        };
        
        // --- Ø´Ø§Ø´Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ---

        const initializeAppUI = async () => {
            if (!currentUser) return;
            ui.myProfileButton.src = currentUser.avatar;
            await loadAndDisplayUsers();
        };

        const loadAndDisplayUsers = async () => {
            try {
                const searchTerm = ui.searchInput.value.toLowerCase().trim();
                const snapshot = await get(ref(database, 'users'));
                ui.contactsContainer.innerHTML = ''; // Clear previous results
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = child.val();
                        if (user.id === currentUser.id) return; // Don't show self

                        // Filter logic
                        const nameMatch = user.name.toLowerCase().includes(searchTerm);
                        const phoneMatch = user.phone.includes(searchTerm);
                        if(searchTerm && !nameMatch && !phoneMatch) return;

                        const contactDiv = document.createElement('div');
                        contactDiv.className = 'contact-item';
                        contactDiv.innerHTML = `
                            <img src="${user.avatar}" alt="${user.name}">
                            <div>
                                <h4>${user.name}</h4>
                                <p style="color:#a0a0a0; font-size:14px;">${user.phone}</p>
                            </div>
                        `;
                        contactDiv.onclick = () => openChat(user);
                        ui.contactsContainer.appendChild(contactDiv);
                    });
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
            }
        };

        ui.searchInput.oninput = loadAndDisplayUsers;
        
        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---

        const openChat = (partner) => {
            activeChatPartner = partner;
            ui.chatPartnerName.textContent = partner.name;
            ui.chatPartnerAvatar.src = partner.avatar;
            navigateTo('chat-page');
            loadAndListenForMessages();
        };

        const loadAndListenForMessages = () => {
            // Stop listening to previous chat
            if (currentMessagesRef && currentMessagesListener) {
                off(currentMessagesRef, 'value', currentMessagesListener);
            }

            const chatId = [currentUser.id, activeChatPartner.id].sort().join('_');
            currentMessagesRef = query(ref(database, 'messages/' + chatId), orderByChild('timestamp'));
            
            ui.messagesArea.innerHTML = ''; // Clear old messages

            currentMessagesListener = onValue(currentMessagesRef, (snapshot) => {
                ui.messagesArea.innerHTML = ''; // Re-render all on new data
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        displayMessage(child.val());
                    });
                }
                 ui.messagesArea.scrollTop = ui.messagesArea.scrollHeight;
            }, (error) => {
                console.error("Error listening for messages:", error);
            });
        };

        const sendMessage = async (messageData) => {
            if (!messageData.content.trim()) return;
            const chatId = [currentUser.id, activeChatPartner.id].sort().join('_');
            const fullMessage = {
                ...messageData,
                senderId: currentUser.id,
                receiverId: activeChatPartner.id,
                timestamp: serverTimestamp()
            };
            try {
                 await push(ref(database, 'messages/' + chatId), fullMessage);
            } catch(e) {
                console.error("Message send error: ", e);
                alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
            }
        };

        const displayMessage = (msg) => {
            const div = document.createElement('div');
            div.className = `message ${msg.senderId === currentUser.id ? 'sent' : 'received'}`;
            
            let contentHtml = '';
            switch(msg.type) {
                case 'text':
                    contentHtml = msg.content.replace(/\n/g, '<br>');
                    break;
                case 'image':
                    contentHtml = `<img src="${msg.content}" alt="ØµÙˆØ±Ø©">`;
                    break;
                case 'audio':
                    contentHtml = `<audio controls src="${msg.content}"></audio>`;
                    break;
                default:
                     contentHtml = 'Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©';
            }
            
            div.innerHTML = contentHtml;
            ui.messagesArea.appendChild(div);
        };
        
        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ---

        ui.messageInput.oninput = () => {
            const hasText = ui.messageInput.value.trim() !== '';
            ui.sendButton.style.display = hasText ? 'flex' : 'none';
            ui.recordButton.style.display = hasText ? 'none' : 'flex';
        };

        ui.messageForm.onsubmit = () => {
            const text = ui.messageInput.value.trim();
            if (text) {
                sendMessage({ type: 'text', content: text });
                ui.messageInput.value = '';
                ui.messageInput.dispatchEvent(new Event('input')); // Update button visibility
            }
            return false; // Prevent form submission
        };
        
        ui.attachmentButton.onclick = () => ui.attachmentInput.click();
        
        ui.attachmentInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const base64Content = await fileToBase64(file);
                const type = file.type.startsWith('image/') ? 'image' : 'video';
                 if (type === 'video') {
                    alert("Ù…ÙŠØ²Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø¨Ø¯Ø£ Ù‡Ùˆ Ù†ÙØ³Ù‡ (ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64).");
                    return;
                }
                sendMessage({ type: 'image', content: base64Content });
            }
            e.target.value = null; // Reset input
        };

        // --- Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ---
        let mediaRecorder;
        let audioChunks = [];

        ui.recordButton.onmousedown = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                ui.recordButton.classList.add('recording');
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = []; // Clear for next recording
                    const base64Audio = await fileToBase64(audioBlob);
                    sendMessage({ type: 'audio', content: base64Audio });
                };

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:", error);
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.");
            }
        };

        ui.recordButton.onmouseup = () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                ui.recordButton.classList.remove('recording');
            }
        };

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
        
        ui.myProfileButton.onclick = () => {
            ui.editPicPreview.src = currentUser.avatar;
            ui.editNameInput.value = currentUser.name;
            ui.editPhoneInput.value = currentUser.phone;
            navigateTo('profile-settings-page');
        };
        
        ui.editPicInput.onchange = async (e) => {
             const file = e.target.files[0];
            if (file) {
                ui.editPicPreview.src = await fileToBase64(file);
            }
        };

        ui.saveProfileButton.onclick = async () => {
            const newName = ui.editNameInput.value.trim();
            const newAvatar = ui.editPicPreview.src;
            if(!newName) {
                alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹");
                return;
            }
            
            const updatedData = {
                ...currentUser,
                name: newName,
                avatar: newAvatar
            };
            
            try {
                await set(ref(database, 'users/' + currentUser.id), updatedData);
                currentUser = updatedData; // Update local copy
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                initializeAppUI(); // Refresh UI
                navigateTo('chat-list-page');
            } catch(error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:", error);
                alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.");
            }
        };
        
        // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø© ---

        ui.backButtons.forEach(b => {
            b.onclick = () => {
                // Stop listening to messages when leaving chat page
                if (currentMessagesRef && currentMessagesListener) {
                    off(currentMessagesRef, 'value', currentMessagesListener);
                    currentMessagesRef = null;
                    currentMessagesListener = null;
                }
                navigateTo(b.dataset.target);
            };
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        startApp();

    } catch (e) {
        console.error("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© ÙƒØ§Ø¦Ù† firebaseConfig.", e);
        document.body.innerHTML = `<div style="text-align:center; padding: 40px; color: red;"><h1>Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</h1><p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</p><p>${e.message}</p></div>`;
    }
</script>

</body>
</html>
