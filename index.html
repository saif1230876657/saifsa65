<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <style>
        :root {
            --primary-bg: #111b21;
            --secondary-bg: #202c33;
            --accent-green: #00a884;
            --text-color: #e0e0e0;
            --sent-bubble: #005c4b;
            --received-bubble: #202c33;
            --danger-red: #f15c5c;
            --seen-blue: #53bdeb; /* --- NEW: Color for seen ticks --- */
            --subtle-text: #8696a0;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        html, body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--primary-bg); color: var(--text-color); height: 100%; width: 100%; overflow: hidden; }
        .page { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--primary-bg); position: absolute; top: 0; left: 0; }
        .page.active { display: flex; }
        header { background: var(--secondary-bg); padding: 10px 15px; display: flex; align-items: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; overflow-y: auto; }
        button { padding: 12px 25px; background: var(--accent-green); color: white; font-weight: bold; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        input[type="text"], input[type="tel"], input[type="search"] { width: 85%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--secondary-bg); background: var(--secondary-bg); color: white; text-align: center; font-size: 16px; }
        .back-button { color: white; font-size: 24px; background: none; border: none; cursor: pointer; padding: 0 15px 0 5px; margin: 0; }
        .profile-pic-container { position: relative; width: 150px; height: 150px; margin-bottom: 20px; flex-shrink: 0; }
        .profile-pic-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary-bg); background: #333; }
        .profile-pic-overlay { position: absolute; bottom: 5px; left: 5px; width: 40px; height: 40px; background: var(--accent-green); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 20px; }
        #chat-list-page-header { justify-content: space-between; }
        #my-profile-button { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; background: #333; }
        #chat-list-page .content { padding: 0; width: 100%; }
        #search-form { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--primary-bg); width: 100%; box-sizing: border-box; }
        #search-input { margin: 0; flex-grow: 1; text-align: right; }
        #search-button { margin: 0; padding: 10px 20px; width: auto; }
        #contacts-container { flex-grow: 1; overflow-y: auto; width: 100%; }
        .contact-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid #1a242a; cursor: pointer; text-align: right; width: 100%; box-sizing: border-box; position: relative; }
        .contact-item:hover { background: #2a3942; }
        .contact-item img { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; background: #333; }
        .contact-info { flex-grow: 1; }
        .contact-meta { position: absolute; left: 12px; top: 12px; text-align: left; font-size: 12px; color: var(--subtle-text); }
        .unread-badge { background-color: var(--accent-green); color: white; border-radius: 50%; font-size: 12px; font-weight: bold; padding: 2px 7px; min-width: 20px; text-align: center; position: absolute; left: 12px; bottom: 12px; }
        #no-contacts-message { padding: 40px 20px; color: #8696a0; }
        #chat-page { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
        #chat-page-header { justify-content: flex-start; }
        #chat-partner-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; margin-left: 10px; }
        #messages-area { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; }
        .message { display: flex; flex-direction: column; max-width: 70%; padding: 6px 9px; border-radius: 8px; margin-bottom: 10px; color: white; word-wrap: break-word; line-height: 1.4; position: relative; }
        .message .message-content { padding-right: 50px; } /* --- NEW: space for timestamp and ticks --- */
        .message img, .message video { max-width: 100%; border-radius: 5px; margin-top: 5px; }
        .message audio { width: 250px; filter: invert(1) sepia(1) saturate(0) hue-rotate(180deg); }
        .message-meta { position: absolute; bottom: 4px; right: 8px; font-size: 11px; color: #ffffff99; display: flex; align-items: center; }
        .message-meta .ticks { font-weight: bold; margin-left: 3px; font-size: 16px; }
        .message-meta .ticks.seen { color: var(--seen-blue); }
        .sent { background: var(--sent-bubble); align-self: flex-end; }
        .received { background: var(--received-bubble); align-self: flex-start; }
        #message-form { display: flex; padding: 8px; align-items: center; background: var(--primary-bg); width: 100%; box-sizing: border-box; flex-shrink: 0; }
        #message-input { flex-grow: 1; padding: 12px 15px; border-radius: 20px; border: none; background: var(--secondary-bg); color: white; margin: 0 8px; }
        .action-button { min-width: 48px; height: 48px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: var(--accent-green); color: white; font-size: 24px; cursor: pointer; border: none; padding: 0; margin: 0; }
        #attachment-button { background: none; color: #8696a0; font-size: 26px; transform: rotate(45deg); }
        #record-button, #send-button { display: none; }
        #recording-ui { display: none; flex-grow: 1; height: 48px; background-color: var(--secondary-bg); border-radius: 20px; margin: 0 8px; padding: 0 10px; align-items: center; justify-content: space-between; }
        #cancel-record-button { background: none; color: var(--danger-red); font-size: 24px; }
        #recording-status { display: flex; align-items: center; color: var(--text-color); }
        #recording-status .red-dot { color: var(--danger-red); font-size: 16px; animation: pulse 1.5s infinite; margin-left: 8px; }
    </style>
</head>
<body>

<div id="welcome-page" class="page active"><div class="content"><h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨</h2><p style="color: #a0a0a0;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©" Ù„Ù‚Ø¨ÙˆÙ„ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©.</p><button id="agree-button">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button></div></div>
<div id="phone-page" class="page"><header><button class="back-button" data-target="welcome-page">â†’ </button><h1>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</h1></header><div class="content"><p style="color: #a0a0a0;">Ø³ÙŠÙ‚ÙˆÙ… ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ.</p><input type="tel" id="phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"><button id="phone-next-button">Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>
<div id="profile-page" class="page"><header><h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1></header><div class="content"><p style="color: #a0a0a0;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©.</p><div class="profile-pic-container"><label for="register-pic-input"><img id="register-pic-preview" class="profile-pic-preview" src="https://via.placeholder.com/150/333333/FFFFFF?text=User"><div class="profile-pic-overlay">ğŸ“·</div></label><input type="file" id="register-pic-input" accept="image/*" style="display:none;"></div><input type="text" id="register-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§"><button id="register-finish-button">Ø¥Ù†Ù‡Ø§Ø¡</button></div></div>

<div id="chat-list-page" class="page">
    <header id="chat-list-page-header"><img id="my-profile-button" src="https://via.placeholder.com/150/333333/FFFFFF?text=Me"><h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h2></header>
    <div class="content">
        <form id="search-form" onsubmit="return false;">
            <input type="search" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙƒØ§Ù…Ù„...">
            <button type="submit" id="search-button">Ø¨Ø­Ø«</button>
        </form>
        <div id="contacts-container"><div id="no-contacts-message"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¯Ø´Ø§Øª Ø¨Ø¹Ø¯</h3><p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙÙ‡ Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©.</p></div></div>
    </div>
</div>

<div id="profile-settings-page" class="page"><header><button class="back-button" data-target="chat-list-page">â†’ </button><h1>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1></header><div class="content"><div class="profile-pic-container"><label for="edit-pic-input"><img id="edit-pic-preview" class="profile-pic-preview"><div class="profile-pic-overlay">ğŸ“·</div></label><input type="file" id="edit-pic-input" accept="image/*" style="display:none;"></div><input type="text" id="edit-name-input" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="tel" id="edit-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" readonly style="background:#111b21; text-align:center;"><button id="save-profile-button">Ø­ÙØ¸</button></div></div>
<div id="chat-page" class="page"><header id="chat-page-header"><button class="back-button" data-target="chat-list-page">â†’ </button><img id="chat-partner-avatar"><h3 id="chat-partner-name" style="margin-right: 15px;"></h3></header><div id="messages-area"></div><form id="message-form" onsubmit="return false;"><button type="button" id="attachment-button" class="action-button">ğŸ“</button><input type="file" id="attachment-input" accept="image/,video/" style="display:none;"><input type="text" id="message-input" placeholder="Ø±Ø³Ø§Ù„Ø©"><div id="recording-ui"><button type="button" id="cancel-record-button" class="action-button" title="Ø¥Ù„ØºØ§Ø¡">ğŸ—‘</button><div id="recording-status"><span id="record-timer">0:00</span><span class="red-dot">â—</span></div></div><button type="button" id="record-button" class="action-button">ğŸ¤</button><button type="submit" id="send-button" class="action-button">â¤</button></form></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off, query, orderByChild, equalTo, serverTimestamp, update, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcqpstSz3Wg6zQb_-bC0JyjcJjX5c3TQ8",
        authDomain: "saifsa-d4bee.firebaseapp.com",
        databaseURL: "https://saifsa-d4bee-default-rtdb.firebaseio.com",
        projectId: "saifsa-d4bee",
        storageBucket: "saifsa-d4bee.firebasestorage.app",
        messagingSenderId: "56650923251",
        appId: "1:56650923251:web:83ed4afadf44f8eabf0b86"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let currentUser = null, activeChatPartner = null, registrationData = { avatar: "https://via.placeholder.com/150/333333/FFFFFF?text=User" };
        let currentMessagesRef = null, currentMessagesListener = null, userChatsListener = null;
        let mediaRecorder, audioChunks = [], recordTimerInterval, isRecording = false;

        const ui = {
            pages: document.querySelectorAll('.page'), backButtons: document.querySelectorAll('.back-button'), agreeButton: document.getElementById('agree-button'), phoneNextButton: document.getElementById('phone-next-button'), phoneInput: document.getElementById('phone-input'), registerPicInput: document.getElementById('register-pic-input'), registerPicPreview: document.getElementById('register-pic-preview'), registerNameInput: document.getElementById('register-name-input'), registerFinishButton: document.getElementById('register-finish-button'), myProfileButton: document.getElementById('my-profile-button'),
            searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'),
            contactsContainer: document.getElementById('contacts-container'), noContactsMessage: document.getElementById('no-contacts-message'), editPicPreview: document.getElementById('edit-pic-preview'), editPicInput: document.getElementById('edit-pic-input'), editNameInput: document.getElementById('edit-name-input'), editPhoneInput: document.getElementById('edit-phone-input'), saveProfileButton: document.getElementById('save-profile-button'), chatPartnerName: document.getElementById('chat-partner-name'), chatPartnerAvatar: document.getElementById('chat-partner-avatar'), messagesArea: document.getElementById('messages-area'), messageForm: document.getElementById('message-form'), messageInput: document.getElementById('message-input'), sendButton: document.getElementById('send-button'), recordButton: document.getElementById('record-button'), attachmentButton: document.getElementById('attachment-button'), attachmentInput: document.getElementById('attachment-input'), recordingUi: document.getElementById('recording-ui'), cancelRecordButton: document.getElementById('cancel-record-button'), recordTimer: document.getElementById('record-timer')
        };
        
        const navigateTo = (pageId) => { ui.pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if(pageId === 'chat-list-page' && currentUser) { loadUserChats(); }};
        const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
        const startApp = async () => { const savedUserId = localStorage.getItem('whatsapp_currentUser_id'); if (savedUserId) { try { const snapshot = await get(ref(database, 'users/' + savedUserId)); if (snapshot.exists()) { currentUser = snapshot.val(); initializeAppUI(); navigateTo('chat-list-page'); } else { localStorage.removeItem('whatsapp_currentUser_id'); navigateTo('welcome-page'); } } catch (error) { console.error("DB connection failed:", error); alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); navigateTo('welcome-page'); } } else { navigateTo('welcome-page'); } };
        ui.agreeButton.onclick = () => navigateTo('phone-page');
        ui.phoneNextButton.onclick = async () => { const phone = ui.phoneInput.value.trim(); if (phone.length < 9) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­'); return; } const usersQuery = query(ref(database, 'users'), orderByChild('phone'), equalTo(phone)); const snapshot = await get(usersQuery); if (snapshot.exists()) { alert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ."); snapshot.forEach(child => { currentUser = child.val(); }); localStorage.setItem('whatsapp_currentUser_id', currentUser.id); initializeAppUI(); navigateTo('chat-list-page'); } else { registrationData.phone = phone; navigateTo('profile-page'); } };
        ui.registerPicInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { ui.registerPicPreview.src = await fileToBase64(file); registrationData.avatar = ui.registerPicPreview.src; } };
        ui.registerFinishButton.onclick = async () => { const name = ui.registerNameInput.value.trim(); if (!name) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ'); return; } registrationData.name = name; const userId = user_${Date.now()}; const newUser = { id: userId, ...registrationData, chats: {} }; try { await set(ref(database, 'users/' + userId), newUser); currentUser = newUser; localStorage.setItem('whatsapp_currentUser_id', currentUser.id); alert(ØªÙ… ØªØ³Ø¬ÙŠÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­!); initializeAppUI(); navigateTo('chat-list-page'); } catch (error) { console.error("Error saving user:", error); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„."); } };
        const initializeAppUI = () => { if (!currentUser) return; ui.myProfileButton.src = currentUser.avatar; };

        // --- MODIFIED: Search Logic ---
        ui.searchButton.onclick = async () => {
            const searchTerm = ui.searchInput.value.trim();
            if (!searchTerm || !currentUser) return;
            if (searchTerm === currentUser.phone) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ù†ÙØ³Ùƒ."); return; }
            const usersQuery = query(ref(database, 'users'), orderByChild('phone'), equalTo(searchTerm));
            const snapshot = await get(usersQuery);
            if (snapshot.exists()) {
                snapshot.forEach(child => { openChat(child.val()); });
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….");
            }
        };

        // --- NEW: Load User's Chat List ---
        const loadUserChats = () => {
            if (userChatsListener) off(ref(database, 'users/' + currentUser.id + '/chats'), 'value', userChatsListener);
            
            const chatsRef = query(ref(database, 'users/' + currentUser.id + '/chats'), orderByChild('timestamp'));
            userChatsListener = onValue(chatsRef, async (snapshot) => {
                ui.contactsContainer.innerHTML = '';
                if (!snapshot.exists() || snapshot.val() === null) {
                    ui.contactsContainer.appendChild(ui.noContactsMessage);
                    ui.noContactsMessage.style.display = 'block';
                    return;
                }
                ui.noContactsMessage.style.display = 'none';

                const chats = [];
                snapshot.forEach(child => { chats.push({ partnerId: child.key, ...child.val() }); });
                chats.sort((a, b) => b.timestamp - a.timestamp); // Sort descending by timestamp

                for (const chat of chats) {
                    const userSnap = await get(ref(database, 'users/' + chat.partnerId));
                    if(userSnap.exists()){
                        const partner = userSnap.val();
                        const contactDiv = document.createElement('div');
                        contactDiv.className = 'contact-item';
                        contactDiv.onclick = () => openChat(partner);
                        
                        let lastMessageText = '';
                        if (chat.lastMessage) {
                           switch(chat.lastMessageType) {
                                case 'text': lastMessageText = chat.lastMessage.length > 25 ? chat.lastMessage.substring(0, 25) + '...' : chat.lastMessage; break;
                                case 'image': lastMessageText = 'ğŸ“· ØµÙˆØ±Ø©'; break;
                                case 'audio': lastMessageText = 'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©'; break;
                                default: lastMessageText = chat.lastMessage;
                           }
                        }

                        const chatDate = new Date(chat.timestamp).toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit'});

                        contactDiv.innerHTML = `
                            <img src="${partner.avatar}" alt="${partner.name}">
                            <div class="contact-info">
                                <h4>${partner.name}</h4>
                                <p style="color:#a0a0a0; font-size:14px;">${lastMessageText}</p>
                            </div>
                            <div class="contact-meta">
                                <span class="time">${chatDate}</span>
                            </div>
                            ${chat.unreadCount > 0 ? <div class="unread-badge">${chat.unreadCount}</div> : ''}
                        `;
                        ui.contactsContainer.appendChild(contactDiv);
                    }
                }
            });
        };
        
        // --- MODIFIED: Open Chat Logic ---
        const openChat = async (partner) => {
            activeChatPartner = partner;
            ui.chatPartnerName.textContent = partner.name;
            ui.chatPartnerAvatar.src = partner.avatar;
            navigateTo('chat-page');
            loadAndListenForMessages();
            
            // Reset unread count for this chat
            const chatInfoRef = ref(database, users/${currentUser.id}/chats/${partner.id});
            const chatInfoSnap = await get(chatInfoRef);
            if (chatInfoSnap.exists() && chatInfoSnap.val().unreadCount > 0) {
                await update(chatInfoRef, { unreadCount: 0 });
            }
        };

        // --- MODIFIED: Message Handling Logic ---
        const loadAndListenForMessages = () => {
            if (currentMessagesRef && currentMessagesListener) { off(currentMessagesRef, 'value', currentMessagesListener); }
            const chatId = [currentUser.id, activeChatPartner.id].sort().join('_');
            currentMessagesRef = ref(database, 'messages/' + chatId);
            
            ui.messagesArea.innerHTML = '';
            
            currentMessagesListener = onValue(query(currentMessagesRef, orderByChild('timestamp')), async (snapshot) => {
                ui.messagesArea.innerHTML = '';
                if (!snapshot.exists()) return;

                const updates = {};
                snapshot.forEach(child => {
                    const msg = { key: child.key, ...child.val() };
                    // If message is from partner and not 'seen', update status
                    if (msg.senderId === activeChatPartner.id && msg.status !== 'seen') {
                        updates[child.key + '/status'] = 'seen';
                    }
                    displayMessage(msg);
                });

                // Apply status updates in batch
                if (Object.keys(updates).length > 0) {
                    await update(ref(database, 'messages/' + chatId), updates);
                }

                ui.messagesArea.scrollTop = ui.messagesArea.scrollHeight;
            }, (error) => console.error("Error listening for messages:", error));
        };

        // --- MODIFIED: Send Message Logic ---
        const sendMessage = async (messageData) => {
            if (!messageData.content) return;
            const chatId = [currentUser.id, activeChatPartner.id].sort().join('_');
            const messagesRef = ref(database, 'messages/' + chatId);
            
            const fullMessage = {
                ...messageData,
                senderId: currentUser.id,
                receiverId: activeChatPartner.id,
                timestamp: serverTimestamp(),
                status: 'sent' // Initial status
            };
            
            try {
                await push(messagesRef, fullMessage);

                // Update chat metadata for both users
                const chatTimestamp = Date.now();
                const senderChatRef = ref(database, users/${currentUser.id}/chats/${activeChatPartner.id});
                const receiverChatRef = ref(database, users/${activeChatPartner.id}/chats/${currentUser.id});

                await set(senderChatRef, {
                    lastMessage: messageData.content,
                    lastMessageType: messageData.type,
                    timestamp: chatTimestamp,
                    unreadCount: 0 // Sender has no unread messages
                });
                
                await set(receiverChatRef, {
                    lastMessage: messageData.content,
                    lastMessageType: messageData.type,
                    timestamp: chatTimestamp,
                    unreadCount: increment(1) // Increment receiver's unread count
                });
                
            } catch(e) {
                console.error("Message send error:", e);
                alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
            }
        };

        // --- MODIFIED: Display Message Logic ---
        const displayMessage = (msg) => {
            const div = document.createElement('div');
            div.className = message ${msg.senderId === currentUser.id ? 'sent' : 'received'};
            
            let contentHtml = '';
            switch(msg.type) {
                case 'text': contentHtml = msg.content.replace(/\n/g, '<br>'); break;
                case 'image': contentHtml = <img src="${msg.content}" alt="ØµÙˆØ±Ø©">; break;
                case 'audio': contentHtml = <audio controls src="${msg.content}"></audio>; break;
                default: contentHtml = 'Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©';
            }
            
            const msgDate = new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit'});
            
            let ticks = '';
            if (msg.senderId === currentUser.id) {
                if (msg.status === 'seen') {
                    ticks = '<span class="ticks seen">âœ“âœ“</span>';
                } else if (msg.status === 'delivered') { // Note: for simplicity, we jump from sent to seen. Add delivered logic if needed.
                    ticks = '<span class="ticks">âœ“âœ“</span>';
                } else {
                    ticks = '<span class="ticks">âœ“</span>';
                }
            }
            
            div.innerHTML = <div class="message-content">${contentHtml}</div><div class="message-meta"><span>${msgDate}</span>${ticks}</div>;
            ui.messagesArea.appendChild(div);

            // Update status to 'delivered' if received
            if(msg.senderId === activeChatPartner.id && msg.status === 'sent') {
                 const msgRef = ref(database, messages/${[currentUser.id, activeChatPartner.id].sort().join('_')}/${msg.key});
                 update(msgRef, { status: 'delivered' });
            }
        };

        const setRecordingUI = (isRecordingActive) => { isRecording = isRecordingActive; ui.messageInput.style.display = isRecordingActive ? 'none' : 'flex'; ui.attachmentButton.style.display = isRecordingActive ? 'none' : 'flex'; ui.recordingUi.style.display = isRecordingActive ? 'flex' : 'none'; ui.messageInput.dispatchEvent(new Event('input')); };
        ui.messageInput.oninput = () => { if (isRecording) return; const hasText = ui.messageInput.value.trim() !== ''; ui.sendButton.style.display = hasText ? 'flex' : 'none'; ui.recordButton.style.display = hasText ? 'none' : 'flex'; };
        ui.messageForm.onsubmit = () => { if (isRecording) { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); } } else { const text = ui.messageInput.value.trim(); if (text) { sendMessage({ type: 'text', content: text }); ui.messageInput.value = ''; ui.messageInput.dispatchEvent(new Event('input')); } } return false; };
        ui.recordButton.onclick = async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream); audioChunks = []; mediaRecorder.start(); setRecordingUI(true); let seconds = 0; ui.recordTimer.textContent = '0:00'; recordTimerInterval = setInterval(() => { seconds++; const mins = Math.floor(seconds / 60); const secs = seconds % 60; ui.recordTimer.textContent = ${mins}:${secs.toString().padStart(2, '0')}; }, 1000); mediaRecorder.ondataavailable = event => audioChunks.push(event.data); mediaRecorder.onstop = async () => { clearInterval(recordTimerInterval); const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); const base64Audio = await fileToBase64(audioBlob); sendMessage({ type: 'audio', content: base64Audio }); setRecordingUI(false); stream.getTracks().forEach(track => track.stop()); }; } catch (error) { console.error("Microphone access error:", error); alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†."); setRecordingUI(false); } };
        ui.cancelRecordButton.onclick = () => { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.onstop = () => { if(mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(track => track.stop()); }; mediaRecorder.stop(); } clearInterval(recordTimerInterval); audioChunks = []; setRecordingUI(false); };
        ui.attachmentButton.onclick = () => ui.attachmentInput.click();
        ui.attachmentInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { const base64Content = await fileToBase64(file); const type = file.type.startsWith('image/') ? 'image' : 'video'; if (type === 'video') { alert("Ù…ÙŠØ²Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."); return; } sendMessage({ type: 'image', content: base64Content }); } e.target.value = null; };
        ui.myProfileButton.onclick = () => { ui.editPicPreview.src = currentUser.avatar; ui.editNameInput.value = currentUser.name; ui.editPhoneInput.value = currentUser.phone; navigateTo('profile-settings-page'); };
        ui.editPicInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { ui.editPicPreview.src = await fileToBase64(file); } };
        ui.saveProfileButton.onclick = async () => { const newName = ui.editNameInput.value.trim(); const newAvatar = ui.editPicPreview.src; if(!newName) { alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹"); return; } const updatedData = { ...currentUser, name: newName, avatar: newAvatar }; try { await set(ref(database, 'users/' + currentUser.id), updatedData); currentUser = updatedData; alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!"); initializeAppUI(); navigateTo('chat-list-page'); } catch(error) { console.error("Profile update error:", error); alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ."); } };
        ui.backButtons.forEach(b => { b.onclick = () => { if (isRecording) ui.cancelRecordButton.click(); if (currentMessagesRef && currentMessagesListener) { off(currentMessagesRef, 'value', currentMessagesListener); currentMessagesRef = null; currentMessagesListener = null; } if (userChatsListener) { off(ref(database, 'users/' + currentUser.id + '/chats'), 'value', userChatsListener); userChatsListener = null;} navigateTo(b.dataset.target); }; });

        startApp();
        ui.messageInput.dispatchEvent(new Event('input'));
    } catch (e) {
        console.error("Firebase init failed.", e);
        document.body.innerHTML = <div style="text-align:center; padding: 40px; color: red;"><h1>Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</h1><p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</p><p>${e.message}</p></div>;
    }
</script>

</body>
</html>
