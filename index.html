<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <style>
        :root {
            --primary-bg: #111b21;
            --secondary-bg: #202c33;
            --accent-green: #00a884;
            --text-color: #e0e0e0;
            --sent-bubble: #005c4b;
            --received-bubble: #202c33;
            --danger-red: #f15c5c;
            --status-blue: #53bdeb; /* Ù„ÙˆÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
            --light-gray: #8696a0;
            --modal-bg: rgba(0, 0, 0, 0.85);
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        html, body {
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #090e11; color: var(--text-color); height: 100%; width: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        #main-container {
            width: 100%; height: 100%;
            max-width: 450px; /* Fixed max width for phone-like view */
            max-height: 950px; /* Fixed max height */
            background: var(--primary-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }
        .page { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--primary-bg); position: absolute; top: 0; left: 0; }
        .page.active { display: flex; }
        header { background: var(--secondary-bg); padding: 10px 15px; display: flex; align-items: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; overflow-y: auto; }
        button { padding: 12px 25px; background: var(--accent-green); color: white; font-weight: bold; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        input[type="text"], input[type="tel"], input[type="search"] { width: 85%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--secondary-bg); background: var(--secondary-bg); color: white; text-align: center; font-size: 16px; }
        .back-button { color: white; font-size: 24px; background: none; border: none; cursor: pointer; padding: 0 15px 0 5px; margin: 0; }
        .profile-pic-container { position: relative; width: 150px; height: 150px; margin-bottom: 20px; flex-shrink: 0; }
        .profile-pic-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary-bg); background: #333; }
        .profile-pic-overlay { position: absolute; bottom: 5px; left: 5px; width: 40px; height: 40px; background: var(--accent-green); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 20px; }
        #chat-list-page-header { justify-content: space-between; }
        #my-profile-button { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; background: #333; }
        #chat-list-page .content { padding: 0; width: 100%; }
        #search-form { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--primary-bg); width: 100%; box-sizing: border-box; }
        #search-input { margin: 0; flex-grow: 1; text-align: right; }
        #search-button { margin: 0; padding: 10px 20px; width: auto; }
        #contacts-container { flex-grow: 1; overflow-y: auto; width: 100%; }
        .contact-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid #1a242a; cursor: pointer; text-align: right; width: 100%; box-sizing: border-box; }
        .contact-item:hover { background: #2a3942; }
        .contact-item img { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; background: #333; }
        .contact-info { flex-grow: 1; display: flex; flex-direction: column; }
        .contact-info-top { display: flex; justify-content: space-between; align-items: center; }
        .contact-info-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .last-message { font-size: 14px; color: var(--light-gray); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-time { font-size: 12px; color: var(--light-gray); }
        .unread-badge { background-color: var(--accent-green); color: var(--primary-bg); font-size: 12px; font-weight: bold; border-radius: 50%; min-width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; padding: 0 6px; }
        #no-contacts-message { padding: 40px 20px; color: var(--light-gray); }
        #chat-page { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
        #chat-page-header { justify-content: flex-start; }
        #chat-partner-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; margin-left: 10px; }
        #messages-area { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; }
        .message { display: flex; flex-direction: column; max-width: 75%; padding: 6px 10px; border-radius: 8px; margin-bottom: 10px; color: white; word-wrap: break-word; line-height: 1.4; position: relative; }
        .message-content { padding-bottom: 18px; }
        .message img { max-width: 100%; border-radius: 5px; margin-top: 5px; cursor: pointer; }
        .message video { max-width: 100%; border-radius: 5px; margin-top: 5px; }
        .message audio { width: 250px; filter: invert(1) sepia(1) saturate(0) hue-rotate(180deg); }
        .message-meta { position: absolute; bottom: 4px; right: 8px; font-size: 11px; color: var(--light-gray); display: flex; align-items: center; }
        .received .message-meta { right: auto; left: 8px; }
        .message-status { margin-left: 4px; font-weight: bold; font-size: 14px; }
        .status-read { color: var(--status-blue); }
        .sent { background: var(--sent-bubble); align-self: flex-end; }
        .received { background: var(--received-bubble); align-self: flex-start; }
        #message-form { display: flex; padding: 8px; align-items: center; background: var(--primary-bg); width: 100%; box-sizing: border-box; flex-shrink: 0; }
        #message-input { flex-grow: 1; padding: 12px 15px; border-radius: 20px; border: none; background: var(--secondary-bg); color: white; margin: 0 8px; }
        .action-button { min-width: 48px; height: 48px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: var(--accent-green); color: white; font-size: 24px; cursor: pointer; border: none; padding: 0; margin: 0; }
        #attachment-button { background: none; color: var(--light-gray); font-size: 26px; transform: rotate(45deg); }
        #record-button, #send-button { display: none; }
        #recording-ui { display: none; flex-grow: 1; height: 48px; background-color: var(--secondary-bg); border-radius: 20px; margin: 0 8px; padding: 0 15px; align-items: center; justify-content: space-between; }
        #recording-status { display: flex; align-items: center; color: var(--text-color); gap: 8px; }
        #recording-status .red-dot { color: var(--danger-red); font-size: 16px; animation: pulse 1.5s infinite; }
        pre { background-color: #0d1117; border: 1px solid var(--secondary-bg); padding: 10px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; text-align: left; direction: ltr; }
        code { color: #c9d1d9; }
        #image-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #image-viewer img { max-width: 90%; max-height: 80%; object-fit: contain; }
        #image-viewer-controls { margin-top: 15px; display: flex; gap: 20px; }
        #image-viewer-controls button, #image-viewer-controls a { padding: 10px 20px; background: var(--secondary-bg); color: white; font-weight: bold; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; text-decoration: none; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="welcome-page" class="page active"><div class="content"><h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨</h2><p style="color: #a0a0a0;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©" Ù„Ù‚Ø¨ÙˆÙ„ Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©.</p><button id="agree-button">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button></div></div>
    <div id="phone-page" class="page"><header><button class="back-button" data-target="welcome-page">â†’ </button><h1>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</h1></header><div class="content"><p style="color: #a0a0a0;">Ø³ÙŠÙ‚ÙˆÙ… ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ.</p><input type="tel" id="phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"><button id="phone-next-button">Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>
    <div id="profile-page" class="page"><header><h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1></header><div class="content"><p style="color: #a0a0a0;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©.</p><div class="profile-pic-container"><label for="register-pic-input"><img id="register-pic-preview" class="profile-pic-preview" src="https://via.placeholder.com/150/333333/FFFFFF?text=User"><div class="profile-pic-overlay">ğŸ“·</div></label><input type="file" id="register-pic-input" accept="image/*" style="display:none;"></div><input type="text" id="register-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§"><button id="register-finish-button">Ø¥Ù†Ù‡Ø§Ø¡</button></div></div>

    <div id="chat-list-page" class="page">
        <header id="chat-list-page-header"><img id="my-profile-button" src="https://via.placeholder.com/150/333333/FFFFFF?text=Me"><h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h2></header>
        <div class="content">
            <form id="search-form" onsubmit="return false;"> <input type="search" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙƒØ§Ù…Ù„...">
                <button type="submit" id="search-button">Ø¨Ø­Ø«</button>
            </form>
            <div id="contacts-container">
                <div id="no-contacts-message"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¯Ø´Ø§Øª Ø¨Ø¹Ø¯</h3><p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙÙ‡ Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©.</p></div>
            </div>
        </div>
    </div>

    <div id="profile-settings-page" class="page"><header><button class="back-button" data-target="chat-list-page">â†’ </button><h1>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1></header><div class="content"><div class="profile-pic-container"><label for="edit-pic-input"><img id="edit-pic-preview" class="profile-pic-preview"><div class="profile-pic-overlay">ğŸ“·</div></label><input type="file" id="edit-pic-input" accept="image/*" style="display:none;"></div><input type="text" id="edit-name-input" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="tel" id="edit-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" readonly style="background:#111b21; text-align:center;"><button id="save-profile-button">Ø­ÙØ¸</button></div></div>
    <div id="chat-page" class="page"><header id="chat-page-header"><button class="back-button" data-target="chat-list-page">â†’ </button><img id="chat-partner-avatar"><h3 id="chat-partner-name" style="margin-right: 15px;"></h3></header><div id="messages-area"></div><form id="message-form" onsubmit="return false;"><button type="button" id="attachment-button" class="action-button">ğŸ“</button><input type="file" id="attachment-input" accept="image/*,video/*" style="display:none;">
    <div id="recording-ui">
        <div id="recording-status">
            <span class="red-dot">â—</span>
            <span id="record-timer">0:00</span>
        </div>
    </div>
    <input type="text" id="message-input" placeholder="Ø±Ø³Ø§Ù„Ø©">
    <button type="button" id="record-button" class="action-button">ğŸ¤</button>
    <button type="submit" id="send-button" class="action-button">â¤</button>
    </form></div>
</div> <div id="image-viewer">
    <img id="viewer-img" src="">
    <div id="image-viewer-controls">
        <a id="download-btn" href="" download="image.png"><button>ØªÙ†Ø²ÙŠÙ„</button></a>
        <button id="close-viewer-btn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off, query, orderByChild, equalTo, serverTimestamp, update, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    // --- START: FCM INTEGRATION ---
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";
    // --- END: FCM INTEGRATION ---

    const firebaseConfig = {
        apiKey: "AIzaSyCcqpstSz3Wg6zQb_-bC0JyjcJjX5c3TQ8",
        authDomain: "saifsa-d4bee.firebaseapp.com",
        databaseURL: "https://saifsa-d4bee-default-rtdb.firebaseio.com",
        projectId: "saifsa-d4bee",
        storageBucket: "saifsa-d4bee.firebasestorage.app",
        messagingSenderId: "56650923251",
        appId: "1:56650923251:web:83ed4afadf44f8eabf0b86"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // --- START: FCM INTEGRATION ---
        const messaging = getMessaging(app);

        // Function to request permission and get token
        function requestPermission() {
            console.log('Requesting permission...');
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    
                    // Get token
                    getToken(messaging, { vapidKey: 'Ø¶Ø¹_Ù‡Ù†Ø§_Ù…ÙØªØ§Ø­_VAPID_Ø§Ù„Ø®Ø§Øµ_Ø¨Ùƒ' }).then((currentToken) => {
                        if (currentToken) {
                            console.log('FCM Token:', currentToken);
                            // You can now send this token to your server to send notifications
                            // For example, save it to the user's profile in the database
                            if (currentUser) {
                                set(ref(database, `users/${currentUser.id}/fcmToken`), currentToken);
                            }
                        } else {
                            console.log('No registration token available. Request permission to generate one.');
                        }
                    }).catch((err) => {
                        console.log('An error occurred while retrieving token. ', err);
                    });
                } else {
                    console.log('Unable to get permission to notify.');
                }
            });
        }
        
        // Handle incoming messages when the app is in the foreground
        onMessage(messaging, (payload) => {
            console.log('Message received. ', payload);
            // Customize notification here
            new Notification(payload.notification.title, {
                body: payload.notification.body,
                icon: payload.notification.icon,
            });
        });

        // Call requestPermission once the user is logged in
        // --- END: FCM INTEGRATION ---
        
        let currentUser = null, activeChatPartner = null;
        let currentMessagesRef = null, currentMessagesListener = null;
        let userChatsListener = null;
        let mediaRecorder, audioChunks = [], recordTimerInterval, isRecording = false;

        const ui = {
            pages: document.querySelectorAll('.page'), backButtons: document.querySelectorAll('.back-button'), agreeButton: document.getElementById('agree-button'), phoneNextButton: document.getElementById('phone-next-button'), phoneInput: document.getElementById('phone-input'), registerPicInput: document.getElementById('register-pic-input'), registerPicPreview: document.getElementById('register-pic-preview'), registerNameInput: document.getElementById('register-name-input'), registerFinishButton: document.getElementById('register-finish-button'), myProfileButton: document.getElementById('my-profile-button'),
            searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'),
            contactsContainer: document.getElementById('contacts-container'), noContactsMessage: document.getElementById('no-contacts-message'), editPicPreview: document.getElementById('edit-pic-preview'), editPicInput: document.getElementById('edit-pic-input'), editNameInput: document.getElementById('edit-name-input'), editPhoneInput: document.getElementById('edit-phone-input'), saveProfileButton: document.getElementById('save-profile-button'), chatPartnerName: document.getElementById('chat-partner-name'), chatPartnerAvatar: document.getElementById('chat-partner-avatar'), messagesArea: document.getElementById('messages-area'), messageForm: document.getElementById('message-form'), messageInput: document.getElementById('message-input'), sendButton: document.getElementById('send-button'), recordButton: document.getElementById('record-button'), attachmentButton: document.getElementById('attachment-button'), attachmentInput: document.getElementById('attachment-input'),
            recordingUi: document.getElementById('recording-ui'), recordTimer: document.getElementById('record-timer'),
            imageViewer: document.getElementById('image-viewer'), viewerImg: document.getElementById('viewer-img'), downloadBtn: document.getElementById('download-btn'), closeViewerBtn: document.getElementById('close-viewer-btn'),
        };
        
        const navigateTo = (pageId) => { ui.pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); };
        const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
        
        const formatMessageText = (text) => {
            const escapeHTML = (str) => str.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            const codeBlockRegex = /```([\s\S]*?)```/g;
            let formattedText = escapeHTML(text).replace(codeBlockRegex, (match, code) => {
                return `</pre><pre><code>${code.trim()}</code></pre><pre>`;
            });
            formattedText = `<pre>${formattedText}</pre>`.replace(/<pre><\/pre>/g, '').replace(/\n/g, '<br>');
            if (formattedText.startsWith('<pre>') && formattedText.endsWith('</pre>')) {
                 formattedText = formattedText.substring(5, formattedText.length - 6);
            }
            return formattedText;
        };
        
        const startApp = async () => { const savedUserId = localStorage.getItem('whatsapp_currentUser_id'); if (savedUserId) { const snapshot = await get(ref(database, 'users/' + savedUserId)); if (snapshot.exists()) { currentUser = snapshot.val(); initializeAppUI(); navigateTo('chat-list-page'); } else { localStorage.removeItem('whatsapp_currentUser_id'); navigateTo('welcome-page'); } } else { navigateTo('welcome-page'); } };
        ui.agreeButton.onclick = () => navigateTo('phone-page');
        ui.phoneNextButton.onclick = async () => { const phone = ui.phoneInput.value.trim(); if (phone.length < 9) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­'); return; } const usersQuery = query(ref(database, 'users'), orderByChild('phone'), equalTo(phone)); const snapshot = await get(usersQuery); if (snapshot.exists()) { snapshot.forEach(child => { currentUser = child.val(); }); localStorage.setItem('whatsapp_currentUser_id', currentUser.id); initializeAppUI(); navigateTo('chat-list-page'); } else { registrationData.phone = phone; navigateTo('profile-page'); } };
        const registrationData = { avatar: "https://via.placeholder.com/150/333333/FFFFFF?text=User" };
        ui.registerPicInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { ui.registerPicPreview.src = await fileToBase64(file); registrationData.avatar = ui.registerPicPreview.src; } };
        ui.registerFinishButton.onclick = async () => { const name = ui.registerNameInput.value.trim(); if (!name) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ'); return; } registrationData.name = name; const userId = `user_${Date.now()}`; const newUser = { id: userId, ...registrationData }; await set(ref(database, 'users/' + userId), newUser); currentUser = newUser; localStorage.setItem('whatsapp_currentUser_id', currentUser.id); initializeAppUI(); navigateTo('chat-list-page'); };
        
        const initializeAppUI = () => { if (!currentUser) return; ui.myProfileButton.src = currentUser.avatar; loadUserChats(); requestPermission(); /* <-- Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */ };
        
        const loadUserChats = () => {
            if (userChatsListener) off(ref(database, `userChats/${currentUser.id}`), 'value', userChatsListener);
            const chatsQuery = query(ref(database, `userChats/${currentUser.id}`), orderByChild('timestamp'));
            userChatsListener = onValue(chatsQuery, async (snapshot) => {
                ui.contactsContainer.innerHTML = '';
                if (!snapshot.exists()) { ui.noContactsMessage.style.display = 'block'; return; }
                ui.noContactsMessage.style.display = 'none';
                const chatPromises = [];
                snapshot.forEach(child => {
                    const chatData = child.val();
                    const promise = get(ref(database, `users/${chatData.partnerId}`)).then(userSnap => ({ ...chatData, partner: userSnap.val() }));
                    chatPromises.push(promise);
                });
                const chats = (await Promise.all(chatPromises)).reverse();
                chats.forEach(chat => {
                    if(!chat.partner) return;
                    const contactDiv = document.createElement('div');
                    contactDiv.className = 'contact-item';
                    let lastMessageText = '';
                    if (chat.lastMessage) {
                        switch(chat.lastMessage.type) {
                            case 'text': lastMessageText = chat.lastMessage.content; break;
                            case 'image': lastMessageText = 'ğŸ“· ØµÙˆØ±Ø©'; break;
                            case 'audio': lastMessageText = 'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©'; break;
                        }
                    }
                    const messageDate = new Date(chat.timestamp);
                    const messageTime = messageDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    contactDiv.innerHTML = `<img src="${chat.partner.avatar}" alt="${chat.partner.name}"><div class="contact-info"><div class="contact-info-top"><h4>${chat.partner.name}</h4><span class="message-time">${messageTime}</span></div><div class="contact-info-bottom"><span class="last-message">${lastMessageText}</span>${chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : ''}</div></div>`;
                    contactDiv.onclick = () => openChat(chat.partner);
                    ui.contactsContainer.appendChild(contactDiv);
                });
            });
        };
        
        ui.searchForm.onsubmit = async (event) => { event.preventDefault(); const searchTerm = ui.searchInput.value.trim(); if (!searchTerm) return; const usersQuery = query(ref(database, 'users'), orderByChild('phone'), equalTo(searchTerm)); const snapshot = await get(usersQuery); if (snapshot.exists()) { snapshot.forEach(child => { const user = child.val(); if (user.id === currentUser.id) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ù†ÙØ³Ùƒ."); return; } openChat(user); }); } else { alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…."); } };
        const openChat = async (partner) => { activeChatPartner = partner; ui.chatPartnerName.textContent = partner.name; ui.chatPartnerAvatar.src = partner.avatar; navigateTo('chat-page'); loadAndListenForMessages(); await set(ref(database, `userChats/${currentUser.id}/${[currentUser.id, activeChatPartner.id].sort().join('_')}/unreadCount`), 0); };
        const loadAndListenForMessages = () => { if (currentMessagesRef && currentMessagesListener) off(currentMessagesRef, 'value', currentMessagesListener); const chatId = [currentUser.id, activeChatPartner.id].sort().join('_'); currentMessagesRef = query(ref(database, 'messages/' + chatId), orderByChild('timestamp')); ui.messagesArea.innerHTML = ''; currentMessagesListener = onValue(currentMessagesRef, (snapshot) => { ui.messagesArea.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(child => { const msg = child.val(); const msgId = child.key; displayMessage(msg); if (msg.receiverId === currentUser.id && msg.status !== 'read') { update(ref(database, `messages/${chatId}/${msgId}`), { status: 'read' }); } }); } ui.messagesArea.scrollTop = ui.messagesArea.scrollHeight; }); };
        const sendMessage = async (messageData) => { if (!messageData.content) return; const chatId = [currentUser.id, activeChatPartner.id].sort().join('_'); const messageTimestamp = serverTimestamp(); const fullMessage = { ...messageData, senderId: currentUser.id, receiverId: activeChatPartner.id, timestamp: messageTimestamp, status: 'sent' }; await push(ref(database, 'messages/' + chatId), fullMessage); const chatInfo = { partnerId: activeChatPartner.id, lastMessage: messageData, timestamp: messageTimestamp, unreadCount: 0 }; await set(ref(database, `userChats/${currentUser.id}/${chatId}`), chatInfo); const chatInfoForPartner = { partnerId: currentUser.id, lastMessage: messageData, timestamp: messageTimestamp, unreadCount: increment(1) }; await update(ref(database, `userChats/${activeChatPartner.id}/${chatId}`), chatInfoForPartner); };
        
        const displayMessage = (msg) => {
            const div = document.createElement('div');
            div.className = `message ${msg.senderId === currentUser.id ? 'sent' : 'received'}`;
            let contentHtml = '';
            
            switch(msg.type) {
                case 'text': contentHtml = formatMessageText(msg.content); break;
                case 'image': contentHtml = `<img src="${msg.content}" alt="ØµÙˆØ±Ø©">`; break;
                case 'audio': contentHtml = `<audio controls src="${msg.content}"></audio>`; break;
                default: contentHtml = 'Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©';
            }
            
            const messageTime = new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            let statusIcon = '';
            if (msg.senderId === currentUser.id) { statusIcon = msg.status === 'read' ? '<span class="message-status status-read">âœ“âœ“</span>' : '<span class="message-status">âœ“</span>'; }
            
            div.innerHTML = `<div class="message-content">${contentHtml}</div><div class="message-meta"><span>${messageTime}</span>${statusIcon}</div>`;
            
            const imgElement = div.querySelector('img');
            if(imgElement) {
                imgElement.onclick = () => {
                    ui.viewerImg.src = imgElement.src;
                    ui.downloadBtn.href = imgElement.src;
                    ui.imageViewer.style.display = 'flex';
                };
            }

            ui.messagesArea.appendChild(div);
        };
        
        const setRecordingUI = (isRecordingActive) => {
            isRecording = isRecordingActive;
            ui.messageInput.style.display = isRecordingActive ? 'none' : 'flex';
            ui.attachmentButton.style.display = isRecordingActive ? 'none' : 'flex';
            ui.recordingUi.style.display = isRecordingActive ? 'flex' : 'none';
            
            const hasText = ui.messageInput.value.trim() !== '';
            if (isRecordingActive) {
                ui.recordButton.style.display = 'none';
                ui.sendButton.style.display = 'flex';
            } else {
                ui.sendButton.style.display = hasText ? 'flex' : 'none';
                ui.recordButton.style.display = hasText ? 'none' : 'flex';
            }
        };

        ui.messageInput.oninput = () => { if (isRecording) return; const hasText = ui.messageInput.value.trim() !== ''; ui.sendButton.style.display = hasText ? 'flex' : 'none'; ui.recordButton.style.display = hasText ? 'none' : 'flex'; };
        
        ui.messageForm.onsubmit = () => { 
            if (isRecording) { 
                if (mediaRecorder && mediaRecorder.state === "recording") { 
                    mediaRecorder.stop(); 
                }
            } else { 
                let text = ui.messageInput.value.trim();
                if (text) {
                    if (text.length > 1000) {
                        text = text.substring(0, 1000);
                        alert("ØªÙ… Ø§Ù‚ØªØµØ§Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ 1000 Ø­Ø±Ù.");
                    }
                    sendMessage({ type: 'text', content: text }); 
                    ui.messageInput.value = ''; 
                    ui.messageInput.dispatchEvent(new Event('input')); 
                }
            } 
            return false; 
        };

        ui.recordButton.onclick = async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream); audioChunks = []; mediaRecorder.start(); setRecordingUI(true); let seconds = 0; ui.recordTimer.textContent = '0:00'; recordTimerInterval = setInterval(() => { seconds++; const mins = Math.floor(seconds / 60); const secs = seconds % 60; ui.recordTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`; }, 1000); mediaRecorder.ondataavailable = event => audioChunks.push(event.data); mediaRecorder.onstop = async () => { clearInterval(recordTimerInterval); const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); const base64Audio = await fileToBase64(audioBlob); sendMessage({ type: 'audio', content: base64Audio }); setRecordingUI(false); stream.getTracks().forEach(track => track.stop()); }; } catch (error) { console.error("Microphone access error:", error); alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†."); setRecordingUI(false); } };
        
        ui.attachmentButton.onclick = () => ui.attachmentInput.click();
        ui.attachmentInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { const base64Content = await fileToBase64(file); const type = file.type.startsWith('image/') ? 'image' : 'video'; if (type === 'video') { alert("Ù…ÙŠØ²Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."); return; } sendMessage({ type: 'image', content: base64Content }); } e.target.value = null; };
        ui.myProfileButton.onclick = () => { ui.editPicPreview.src = currentUser.avatar; ui.editNameInput.value = currentUser.name; ui.editPhoneInput.value = currentUser.phone; navigateTo('profile-settings-page'); };
        ui.editPicInput.onchange = async (e) => { const file = e.target.files[0]; if (file) { ui.editPicPreview.src = await fileToBase64(file); } };
        ui.saveProfileButton.onclick = async () => { const newName = ui.editNameInput.value.trim(); const newAvatar = ui.editPicPreview.src; if(!newName) { alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹"); return; } const updatedData = { ...currentUser, name: newName, avatar: newAvatar }; await set(ref(database, 'users/' + currentUser.id), updatedData); currentUser = updatedData; alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!"); initializeAppUI(); navigateTo('chat-list-page'); };
        ui.backButtons.forEach(b => { b.onclick = () => { if (isRecording) { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.onstop = () => { if(mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(track => track.stop()); }; mediaRecorder.stop(); } clearInterval(recordTimerInterval); audioChunks = []; setRecordingUI(false); } if (currentMessagesRef && currentMessagesListener) { off(currentMessagesRef, 'value', currentMessagesListener); currentMessagesRef = null; currentMessagesListener = null; } navigateTo(b.dataset.target); }; });
        
        ui.closeViewerBtn.onclick = () => { ui.imageViewer.style.display = 'none'; };

        startApp();
        ui.messageInput.dispatchEvent(new Event('input'));
    } catch (e) {
        console.error("Firebase init failed.", e);
        document.body.innerHTML = `<div style="text-align:center; padding: 40px; color: red;"><h1>Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</h1><p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</p><p>${e.message}</p></div>`;
    }
</script>

</body>
</html>
